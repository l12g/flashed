<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <div id="fps"></div>
    <canvas
      width="550"
      height="400"
      id="canvas"
      style="background-color: #ccc; margin: 50px"
    ></canvas>
    <canvas
      width="550"
      height="400"
      id="canvas2"
      style="background-color: #ddd; margin: 50px"
    ></canvas>
    <script src="./flashthem.js"></script>
    <script>
      const { Stage, Sprite, Event, Bitmap, TextField, MovieClip, Rect } =
        flashthem;

      let fps = 0;
      let t0 = Date.now();

      const stage = new Stage(document.getElementById("canvas"), 550, 400);
      stage.addCanvas(document.getElementById("canvas2"));
      const role = new MovieClip("./st.png", []);
      role.fps = 6;
      fetch("./st.json")
        .then((data) => data.json())
        .then((json) => {
          const cs = json.frames.map((o) => o.frame);
          role.setClips(cs);
          // stage.addChild(role);

          for (let i = 0; i < 1000; i++) {
            var mv = new MovieClip("st.png");
            stage.addChild(mv);
            mv.setClips(cs);
            mv.x = Math.random() * 550;
            mv.y = Math.random() * 400;
          }
        });

      const rect = new Rect(10, 10, "blue");
      const keys = [0, 0, 0, 0];
      const g = 0.98;
      stage.addChild(rect);
      rect.addChild(role);
      rect.x = rect.y = 100;
      // role.width = 100;

      const t = document.querySelector('#fps')

      const bt = new Bitmap("./role.png");
      bt.blendMode = "xor";
      stage.addChildAt(bt, 0);
      bt.x = bt.y = 100;

      document.addEventListener("keydown", (e) => {
        if (e.key === "ArrowRight") {
          keys[3] = 1;
        }
        if (e.key === "ArrowLeft") {
          keys[2] = 1;
        }
        if (e.key === "ArrowUp") {
          keys[0] = 1;
        }
        if (e.key === "ArrowDown") {
          keys[1] = 1;
        }
      });
      document.addEventListener("keyup", (e) => {
        if (e.key === "ArrowRight") {
          keys[3] = 0;
        }
        if (e.key === "ArrowLeft") {
          keys[2] = 0;
        }
        if (e.key === "ArrowUp") {
          keys[0] = 0;
        }
        if (e.key === "ArrowDown") {
          vy = 5;
          keys[1] = 0;
        }
      });
      let vx = 0,
        vy = 0;
      stage.on("enter-frame", (e) => {
        if (keys[0]) {
          vy = -2;
        } else if (keys[1]) {
          vy = 2;
        }
        if (keys[2]) {
          vx = -2;
        } else if (keys[3]) {
          vx = 2;
        }
        role.x += vx;
        role.y += vy;
        role.scaleX = vx > 0 ? 1 : -1;

        if (keys.join("") === "0000") {
          vx *= 0.5;
          vy *= 0.5;
          if (vx <= 0) vx = 0;
          if (vy <= 0) vy = 0;
          role.pause();
        } else {
          role.play();
        }
        rect.rotation += 0.1;
        // bt.rotation += 0.1;
        fps++;
        if (Date.now() - t0 >= 1000) {
          t.innerHTML = `fps: ${fps}`;
          fps = 0;
          t0 = Date.now();
        } else {
        }
      });
      const grid = new Sprite();
      grid.graphics.lineStyle(1, "blue");
      for (let i = 0; i < 20; i++) {
        grid.graphics.drawLine(i * 50, 0, i * 50, 400);
        grid.graphics.drawLine(0, i * 50, 550, i * 50);
      }
      grid.graphics.stroke();
      grid.alpha = 0.1;
      stage.addChildAt(grid, 0);

      // const debug = new Sprite();
      // stage.on("enter-frame", () => {
      //   stage.addChild(debug);
      //   debug.graphics.clear();
      //   debug.graphics.lineStyle(1, "red");
      //   stage.children.forEach((c) => {
      //     if (c === debug) return;
      //     debug.graphics.drawRect(
      //       c.x - c.width / 2,
      //       c.y - c.height / 2,
      //       c.width,
      //       c.height
      //     );
      //   });
      // });
    </script>
  </body>
</html>
